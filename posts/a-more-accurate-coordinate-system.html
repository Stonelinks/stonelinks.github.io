<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
    <meta name="viewport" content="width=device-width">
    <title>A More Accurate Coordinate System - Stonelinks
    </title>
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon">
    <link rel="shortcut icon" href="/images/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400italic,400,700">
    <link rel="stylesheet" href="/style/main.css">
  </head>
  <body>
    <div class="landing"><a href="/" class="brand"><img src="/images/logos/logo-512.png">Stonelinks</a>
      <div class="tagline-bar">Lucas Doyle's website
      </div>
    </div>
    <div role="navigation" class="navbar navbar-default">
      <div class="container">
        <div class="navbar-header">
          <button type="button" data-toggle="collapse" data-target=".navbar-collapse" class="navbar-toggle"><span class="sr-only">Toggle navigation</span><span class="icon-bar"></span><span class="icon-bar"></span><span class="icon-bar"></span></button><a href="/" class="navbar-brand"><img src="/images/logos/logo-512.png">Stonelinks</a>
        </div>
        <div class="navbar-collapse collapse">
          <ul class="nav navbar-nav">
            <li><a href="/blog.html">Blog</a></li>
            <li><a href="/luke.html">About</a></li>
            <li><a href="/projects.html">Projects</a></li>
          </ul>
        </div>
      </div>
    </div>
    <div id="preloaded-images"></div>
    <div class="container">
      <div class="row post">
        <div class="box">
          <div class="col-lg-12 external-links">
            <hr><a href="/posts/a-more-accurate-coordinate-system.html">
              <h1 class="intro-text text-center">A More Accurate Coordinate System<br><small>07. January 2011</small></h1></a>
            <hr><div class="media-container">

<iframe src="http://www.youtube.com/embed/c72tK4KTTj0" frameborder="0" allowfullscreen></iframe>

</div>

<p><span class="caps">RPI</span> health and safety inspections did not take kindly to my <a href="/posts/door-mounted-roboschwarzenegger/">door mounted Robo-Schwarzenegger</a>. Apparently I’m not breaking any rules with an internet controlled webcam hanging from my door, but the power cord across the doorway is a tripping hazard. I took Arnold down and brought him home with me over the break with the goal of teaching myself some python and jumping into&nbsp;OpenCV.</p>
<p><span class="more"></span>  </p>
<p>I played with both OpenCV and Python a few years ago when I more or less <a href="http://blog.jozilla.net/2008/06/27/fun-with-python-opencv-and-face-detection/">followed this tutorial</a>, but ultimately could not get decent control of the camera. I figured the first step in doing this the right way was to get better control over the camera. Below I’ll describe how I accomplished&nbsp;this.</p>
<h3 id="the-arduino">The Arduino</h3>
<p>The old way I had of doing things on the Arduino was very simplistic and took no advantage of any Arduino libraries. Essentially the protocol between the computer and the arduino was a single character corresponding to a single action. Like many modern <span class="caps">PC</span> games, movement of the camera was set up in standard <span class="caps">WASD</span> fashion (“W” moved the Y axis up, “S” moved it down, “A” moved the X axis left, etc). Using <span class="caps">PWM</span> this was straightforward to code: an if-else block that would do things like “if W comes down the serial line, increment the current Y pulse width by 10”. At the end of the if-else block, if it was time to make a pulse the program would bring the pins connected to the servo high, wait for the pulse width, then bring it back low. There was also a hard coded center, and limits set up so the servos did not go past their limits. All in all, very simple, but it got the job done. The new way of doing things is a little more complicated, but is much more useful in terms of precision. It takes inspiration from this <a href="http://principialabs.com/arduino-python-4-axis-servo-control/">wonderful tutorial</a> to take advantages of the Arduino servo libraries and simplify things. First, a three part protocol between the <span class="caps">PC</span> and Arduino is&nbsp;established:</p>
<ol>
<li>The <span class="caps">PC</span> sends a ‘255’ to the Arduino to let it know that we want to move servos. This is good for future expansion because we can use 0-254 to do other things with the micro-controller. For example, send something like ‘254’ to move speed controllers or get a reading from a <span class="caps">GPS</span>. 255 is essentially the servo&nbsp;“channel”.</li>
<li>The <span class="caps">PC</span> sends a number corresponding to the index of a servo on the Arduino it wants to move. In my setup, 1 means the X axis and 2-means the Y&nbsp;axis.</li>
<li>Last, an angle between 0 and 180 is sent telling the Arduino where to move the&nbsp;servo.</li>
</ol>
<p>When implementing this protocol,  in that list is used to pick a servo object to apply the <a href="http://arduino.cc/en/Reference/ServoWrite">write()</a> function that takes the angle in number three as its argument. The Arduino does the rest! There is a catch though – in order for the Arduino to properly instantiate a servo object, you need to use the attach() function. Since there are minimum and maximum pulse widths (hardware limits) we care about so the pan tilt module doesn’t rip itself apart, those minimum and maximum pulse widths need to be known. I actually used the old version of my code and a couple print statements to write a diagnostic program I could use to figure out the pulse width limits. I have that attached as well as the real&nbsp;code.</p>
<h2 id="the-python">The Python</h2>
<p>Now not to diss <span class="caps">PHP</span> or anything (which is what I have most of my experience with at this point), but python just seems like a more grown up language. There is a lot to like about it. Every time I read or hear about something cool being done, it is almost always involves python! So far with the tutorials out there it has been awesome. The python segments here are short and not very advanced. I wrote one important function - move(). It takes an angle and a servo as arguments and – you guessed it – moves the specified servo to their specified angle. One problem though – due to me being an imperfect craftsman and not mounting the servos perfectly straight, the angular position of (90, 90) does not make the camera point straight ahead as one would expect. Therefore I wrote another simple diagnostic function to allow the interactive centering of the servos. Once I had the middle for the X and Y axis, I could use this in the move function to shift the&nbsp;centers.</p>
<p>Once move() was done, I wrote some test code and it worked like a champ! I then started stacking calls to move() inside of loops and I wrote some code to make the camera move in simple rectangles. Some problems then became clear: the pan tilt module either moves too slow, too fast or just spazzes out if you issue enough commands to it. Increasing the baud rate helped to speed things up, however it would still freak out if you told it to move really fast. I determined that there needs to be some delay between move() calls. Once again, I wrote some diagnostic code to determine this. The pan tilt module would move in rectangles with increasingly longer pauses between move() calls. At some critical delay value, the pan tilt module stopped jittering and moved smoothly (but still pretty fast) around the perimeter of the rectangle (turned out to be 0.003 seconds). As a final example of what the system can do, I wrote the spiral code that appears in the video above. It is only a few lines of python, but I spaced them out and commented them for ease of&nbsp;understanding:</p>
<p><span class="dquo">&#8220;</span>`python
def spiral():
    a = .01;  # “stretch” factor for sin and cosine
    t = 0;    # time&nbsp;value</p>
<pre><code># time loop that stops when the stretch factor is 1
while (a &lt; 1) :

    # increase the time step
    t+=1

    # if 50 time steps have gone by, increment a
    if (t % 50 == 0) : a+=.01

    # move the servos to middle, plus or minus some scaled
    # value of sin or cosine. Change &#39;a&#39; to something fixed
    # between 0 and 1 and the spiral is now a circle
    servo.move(1, 90 + a * math.degrees(math.cos(math.radians(t))))
    servo.move(2, 90 + a * math.degrees(math.sin(math.radians(t))))

    # delay between the move calls
    time.sleep(.0045)
</code></pre><p>&#8220;`</p>
<h2 id="conclusion-attachments">Conclusion <span class="amp">&amp;</span> Attachments</h2>
<p>So that was it! Now I have unrestricted access to use python to do (almost) whatever I want! Looking at the python bindings for OpenCV&nbsp;next!</p>
<ul>
<li><a href="http://dl.dropbox.com/u/4428042/stonelinks_public/main.cpp">Arduino main code</a></li>
<li><a href="http://dl.dropbox.com/u/4428042/stonelinks_public/servolimits.cpp">Arduino servo pulsewidth diagnostic&nbsp;code</a></li>
<li><a href="http://dl.dropbox.com/u/4428042/stonelinks_public/main.py">Python main code</a></li>
<li><a href="http://dl.dropbox.com/u/4428042/stonelinks_public/servo.py">Python servo module</a></li>
</ul>

          </div>
        </div>
      </div>
      <div class="row tag-row">
        <div class="box">
          <div class="col-lg-12">
            <p>Tags: <a href="/tag/robots/1/"><span class="label label-info tag">robots</span></a><a href="/tag/computer%20vision/1/"><span class="label label-info tag">computer vision</span></a><a href="/tag/python/1/"><span class="label label-info tag">python</span></a><a href="/tag/arduino/1/"><span class="label label-info tag">arduino</span></a>
            </p>
          </div>
        </div>
      </div>
    </div>
    <div class="row footer-row">
      <div class="box">
        <div class="col-lg-12"><a href="/blog.html">
            <h4>« Back</h4></a></div>
      </div>
    </div>
    <footer>
      <div class="container">
        <div class="row">
          <div class="col-lg-12 text-center"><a href="https://www.facebook.com/stonelinks" target="_blank" class="social"><i class="fa fa-facebook"></i></a><a href="https://github.com/Stonelinks" target="_blank" class="social"><i class="fa fa-github"></i></a><a href="https://twitter.com/#!/Stonelinks" target="_blank" class="social"><i class="fa fa-twitter"></i></a><a href="https://plus.google.com/116178490514652721625/posts" target="_blank" class="social"><i class="fa fa-google-plus"></i></a><a href="http://www.linkedin.com/pub/lucas-doyle/25/550/169" target="_blank" class="social"><i class="fa fa-linkedin"></i></a><a href="http://www.youtube.com/user/RealStonelinks" target="_blank" class="social"><i class="fa fa-youtube"></i></a><a href="mailto:lucas.p.doyle@gmail.com?Subject=Hello" target="_top" class="footer-link">
               
              contact</a>
          </div>
        </div>
      </div>
    </footer>
    <script src="/node_modules/jquery/dist/jquery.js"></script>
    <script src="/node_modules/underscore/underscore.js"></script>
    <script src="/node_modules/bootstrap/dist/js/bootstrap.min.js"></script>
    <script type="text/javascript">var BG_IMAGES = ["/images/backgrounds/06uh37r.jpg","/images/backgrounds/14206376348_fca4af4ba5_o.jpg","/images/backgrounds/1979230_10152035339809685_1025831531_o.jpg","/images/backgrounds/2000-01-01 08.30.12.jpg","/images/backgrounds/2012-12-02 00.41.05.jpg","/images/backgrounds/2012-12-06 15.09.02.jpg","/images/backgrounds/2013-05-01 08.31.27.jpg","/images/backgrounds/2013-05-18 13.07.32.jpg","/images/backgrounds/2013-09-20 05.26.41.jpg","/images/backgrounds/2013-09-20 05.30.41.jpg","/images/backgrounds/2013-11-24 18.07.08.jpg","/images/backgrounds/2013-12-20 14.27.13.jpg","/images/backgrounds/2013-12-28 19.16.24.jpg","/images/backgrounds/287299main_dextre_iss017_big_full.jpg","/images/backgrounds/34DnPmX.jpg","/images/backgrounds/5bml6q6.jpg","/images/backgrounds/A52It0Q.jpg","/images/backgrounds/Boeing_747-8_Test_Planes_in_Assembly.jpg","/images/backgrounds/CkGmW8I.png","/images/backgrounds/d7t5BrZ.jpg","/images/backgrounds/Dtd8OaS.jpg","/images/backgrounds/enukwns.jpg","/images/backgrounds/Eourq.jpg","/images/backgrounds/EWwV235.jpg","/images/backgrounds/fr42b.jpg","/images/backgrounds/g8yF11T.jpg","/images/backgrounds/GkWIkzl.jpg","/images/backgrounds/godD0Nj.jpg","/images/backgrounds/GpCUV.jpg","/images/backgrounds/HsiDzD2.jpg","/images/backgrounds/IijALtC.jpg","/images/backgrounds/IMG_1142 copy-X2.jpg","/images/backgrounds/IMG_20120721_181258.jpg","/images/backgrounds/isu4ciW.jpg","/images/backgrounds/IZyTICW.jpg","/images/backgrounds/J8Oqyyd.jpg","/images/backgrounds/k9JWU9N.jpg","/images/backgrounds/KBMGZnm.jpg","/images/backgrounds/kkhlkasdhjl3.png","/images/backgrounds/m1gD1NC.jpg","/images/backgrounds/m95qL89.jpg","/images/backgrounds/MbN1OhC.jpg","/images/backgrounds/mooCZ.jpg","/images/backgrounds/nBEcpIY.jpg","/images/backgrounds/nLpQ2G3.jpg","/images/backgrounds/nUje1Xs.jpg","/images/backgrounds/ONn4OVE.jpg","/images/backgrounds/ozjI2XF.jpg","/images/backgrounds/p0QNNrI.jpg","/images/backgrounds/P0UhJaz.jpg","/images/backgrounds/raddmHE.jpg","/images/backgrounds/Red, White and Enterprise-X3.jpg","/images/backgrounds/rhvP0wn.jpg","/images/backgrounds/s_f02_RTR3FJM0.jpg","/images/backgrounds/STS-134_International_Space_Station_after_undocking.jpg","/images/backgrounds/Su0YWko.jpg","/images/backgrounds/tmEkJ7Q.jpg","/images/backgrounds/TuBipfq.jpg","/images/backgrounds/TUZyh.jpg","/images/backgrounds/uCr3S.jpg","/images/backgrounds/uMrsMXh.jpg","/images/backgrounds/w0Pgof8.jpg","/images/backgrounds/wallpaper-1312831.jpg","/images/backgrounds/wallpaper-1441536.jpg","/images/backgrounds/wjZsmhr.jpg","/images/backgrounds/Wsvb8tw.jpg","/images/backgrounds/wvgRzh6.jpg","/images/backgrounds/x2bkKQS.jpg","/images/backgrounds/xkl9FoE.jpg","/images/backgrounds/xKTWtJC.jpg","/images/backgrounds/XvkHfUA.jpg","/images/backgrounds/y4WGD7I.jpg","/images/backgrounds/yrZCDd1.jpg","/images/backgrounds/YseOPg6.jpg","/images/backgrounds/ZhWyntZ.jpg"];
      var BASENAME = 'posts/a-more-accurate-coordinate-system';
       
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');
      ga('create', 'UA-18750328-2', 'auto');
      ga('send', 'pageview');
    </script>
    <script src="/js/main.js"></script>
  </body>
</html>