<!DOCTYPE html>
 <html lang="en"><head><meta charset="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><meta name="viewport" content="width=device-width, initial-scale=1.0 maximum-scale=5.0"/><title>A More Accurate Coordinate System - Stonelinks</title><style id="typography.js">html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}body{margin:0}article,aside,details,figcaption,figure,footer,header,main,menu,nav,section,summary{display:block}audio,canvas,progress,video{display:inline-block}audio:not([controls]){display:none;height:0}progress{vertical-align:baseline}[hidden],template{display:none}a{background-color:transparent;-webkit-text-decoration-skip:objects}a:active,a:hover{outline-width:0}abbr[title]{border-bottom:none;text-decoration:underline;text-decoration:underline dotted}b,strong{font-weight:inherit;font-weight:bolder}dfn{font-style:italic}h1{font-size:2em;margin:.67em 0}mark{background-color:#ff0;color:#000}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}svg:not(:root){overflow:hidden}code,kbd,pre,samp{font-family:monospace,monospace;font-size:1em}figure{margin:1em 40px}hr{box-sizing:content-box;height:0;overflow:visible}button,input,optgroup,select,textarea{font:inherit;margin:0}optgroup{font-weight:700}button,input{overflow:visible}button,select{text-transform:none}[type=reset],[type=submit],button,html [type=button]{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-cancel-button,[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-input-placeholder{color:inherit;opacity:.54}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}html{font:112.5%/1.61em Lato,sans-serif;box-sizing:border-box;overflow-y:scroll;}*{box-sizing:inherit;}*:before{box-sizing:inherit;}*:after{box-sizing:inherit;}body{color:hsla(0,0%,0%,0.8);font-family:Lato,sans-serif;font-weight:400;word-wrap:break-word;}img{max-width:100%;margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.61rem;}h1{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.61rem;color:inherit;font-family:Lato,sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.618rem;line-height:2.415rem;}h2{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.61rem;color:inherit;font-family:Lato,sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.33471rem;line-height:1.61rem;}h3{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.61rem;color:inherit;font-family:Lato,sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1.21225rem;line-height:1.61rem;}h4{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.61rem;color:inherit;font-family:Lato,sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:1rem;line-height:1.61rem;}h5{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.61rem;color:inherit;font-family:Lato,sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:0.90825rem;line-height:1.61rem;}h6{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.61rem;color:inherit;font-family:Lato,sans-serif;font-weight:700;text-rendering:optimizeLegibility;font-size:0.86558rem;line-height:1.61rem;}hgroup{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.61rem;}ul{margin-left:1.61rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.61rem;list-style-position:outside;list-style-image:none;}ol{margin-left:1.61rem;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.61rem;list-style-position:outside;list-style-image:none;}dl{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.61rem;}dd{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.61rem;}p{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.61rem;}figure{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.61rem;}pre{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.61rem;font-size:0.85rem;line-height:1.61rem;}table{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.61rem;font-size:1rem;line-height:1.61rem;border-collapse:collapse;width:100%;}fieldset{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.61rem;}blockquote{margin-left:1.61rem;margin-right:1.61rem;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.61rem;}form{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.61rem;}noscript{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.61rem;}iframe{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.61rem;}hr{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:calc(1.61rem - 1px);background:hsla(0,0%,0%,0.2);border:none;height:1px;}address{margin-left:0;margin-right:0;margin-top:0;padding-bottom:0;padding-left:0;padding-right:0;padding-top:0;margin-bottom:1.61rem;}b{font-weight:700;}strong{font-weight:700;}dt{font-weight:700;}th{font-weight:700;}li{margin-bottom:calc(1.61rem / 2);}ol li{padding-left:0;}ul li{padding-left:0;}li > ol{margin-left:1.61rem;margin-bottom:calc(1.61rem / 2);margin-top:calc(1.61rem / 2);}li > ul{margin-left:1.61rem;margin-bottom:calc(1.61rem / 2);margin-top:calc(1.61rem / 2);}code{font-size:0.85rem;line-height:1.61rem;}kbd{font-size:0.85rem;line-height:1.61rem;}samp{font-size:0.85rem;line-height:1.61rem;}abbr{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}acronym{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;}abbr[title]{border-bottom:1px dotted hsla(0,0%,0%,0.5);cursor:help;text-decoration:none;}thead{text-align:left;}td,th{text-align:left;border-bottom:1px solid hsla(0,0%,0%,0.12);font-feature-settings:tnum;padding-left:1.07333rem;padding-right:1.07333rem;padding-top:0.805rem;padding-bottom:calc(0.805rem - 1px);}th:first-child,td:first-child{padding-left:0;}th:last-child,td:last-child{padding-right:0;}</style><link rel="stylesheet" type="text/css" href="/font-awesome.css"/><link rel="stylesheet" type="text/css" href="/image-gallery.css"/><link rel="stylesheet" type="text/css" href="/css/zenburn.css"/><link rel="stylesheet" type="text/css" href="/css/style.css"/><link href="//fonts.googleapis.com/css?family=Lato:400,700" rel="stylesheet" type="text/css"/></head><body><div id="react-mount"><div style="max-width:41.86rem;margin-left:auto;margin-right:auto;padding:1.2075rem;" data-reactroot="" data-reactid="1" data-react-checksum="-1445066396"><header style="margin-bottom:1.61rem;" data-reactid="2"><div data-reactid="3"><h3 style="margin-top:0;margin-bottom:0;font-size:1.33471rem;line-height:1.61rem;" data-reactid="4"><a style="box-shadow:none;text-decoration:none;color:inherit;" href="/" data-reactid="5"><img src="/icon.png" style="margin:0;margin-top:-4px;border:0;width:35px;height:35px;vertical-align:middle;" data-reactid="6"/><!-- react-text: 7 --> <!-- /react-text --><!-- react-text: 8 -->Stonelinks<!-- /react-text --></a></h3></div><hr style="margin-top:0.805rem;margin-bottom:0.805rem;background-color:gray;" data-reactid="9"/><span data-reactid="10"><a href="/" data-reactid="11">Home</a><!-- react-text: 12 --> | <!-- /react-text --><a href="/posts/" data-reactid="13">Posts</a><!-- react-text: 14 --> | <!-- /react-text --><a href="/projects/" data-reactid="15">Projects</a><!-- react-text: 16 --> | <!-- /react-text --><a href="/about/" data-reactid="17">About</a></span></header><div class="markdown" data-reactid="18"><div data-reactid="19"><h1 style="margin-top:0;margin-bottom:0.4025rem;" data-reactid="20">A More Accurate Coordinate System</h1><div style="margin-top:0.4025rem;margin-bottom:0.805rem;font-size:0.805rem;color:gray;" data-reactid="21">01/06/2011</div></div><div class="article" data-reactid="22"><iframe src="http://www.youtube.com/embed/c72tK4KTTj0" frameborder="0" allowfullscreen></iframe>
<p>RPI health and safety inspections did not take kindly to my <a href="/posts/door-mounted-roboschwarzenegger/">door mounted Robo-Schwarzenegger</a>. Apparently I’m not breaking any rules with an internet controlled webcam hanging from my door, but the power cord across the doorway is a tripping hazard. I took Arnold down and brought him home with me over the break with the goal of teaching myself some python and jumping into OpenCV.</p>
<p>I played with both OpenCV and Python a few years ago when I more or less <a href="http://blog.jozilla.net/2008/06/27/fun-with-python-opencv-and-face-detection/">followed this tutorial</a>, but ultimately could not get decent control of the camera. I figured the first step in doing this the right way was to get better control over the camera. Below I’ll describe how I accomplished this.</p>
<h3>The Arduino</h3>
<p>The old way I had of doing things on the Arduino was very simplistic and took no advantage of any Arduino libraries. Essentially the protocol between the computer and the arduino was a single character corresponding to a single action. Like many modern PC games, movement of the camera was set up in standard WASD fashion (“W” moved the Y axis up, “S” moved it down, “A” moved the X axis left, etc). Using PWM this was straightforward to code: an if-else block that would do things like “if W comes down the serial line, increment the current Y pulse width by 10”. At the end of the if-else block, if it was time to make a pulse the program would bring the pins connected to the servo high, wait for the pulse width, then bring it back low. There was also a hard coded center, and limits set up so the servos did not go past their limits. All in all, very simple, but it got the job done.</p>
<p>The new way of doing things is a little more complicated, but is much more useful in terms of precision. It takes inspiration from this <a href="http://principialabs.com/arduino-python-4-axis-servo-control/">wonderful tutorial</a> to take advantages of the Arduino servo libraries and simplifies things. First, a three part protocol between the PC and Arduino is established:</p>
<ol>
<li>The PC sends a ‘255’ to the Arduino to let it know that we want to move servos. This is good for future expansion because we can use 0-254 to do other things with the micro-controller. For example, send something like ‘254’ to move speed controllers or get a reading from a GPS. 255 is essentially the servo “channel”.</li>
<li>The PC sends a number corresponding to the index of a servo on the Arduino it wants to move. In my setup, 1 means the X axis and 2-means the Y axis.</li>
<li>Last, an angle between 0 and 180 is sent telling the Arduino where to move the servo.</li>
</ol>
<p>When implementing this protocol, in that list is used to pick a servo object to apply the servo <a href="http://arduino.cc/en/Reference/ServoWrite"><code>write()</code></a> function that takes the angle in number three as its argument. The Arduino does the rest! There is a catch though – in order for the Arduino to properly instantiate a servo object, you need to use the <code>attach()</code> function. Since there are minimum and maximum pulse widths (hardware limits) we care about so the pan tilt module doesn’t rip itself apart, those minimum and maximum pulse widths need to be known. I actually used the old version of my code and a couple print statements to write a diagnostic program I could use to figure out the pulse width limits. I have that attached as well as the real code.</p>
<h2>The Python</h2>
<p>Now not to diss PHP or anything (which is what I have most of my experience with at this point), but python just seems like a more grown up language. There is a lot to like about it. Every time I read or hear about something cool being done, it is almost always involves python! So far with the tutorials out there it has been awesome. The python segments here are short and not very advanced. I wrote one important function - <code>move()</code>. It takes an angle and a servo as arguments and – you guessed it – moves the specified servo to their specified angle. One problem though – due to me being an imperfect craftsman and not mounting the servos perfectly straight, the angular position of (90, 90) does not make the camera point straight ahead as one would expect. Therefore I wrote another simple diagnostic function to allow the interactive centering of the servos. Once I had the middle for the X and Y axis, I could use this in the move function to shift the centers.</p>
<p>Once <code>move()</code> was done, I wrote some test code and it worked like a champ! I then started stacking calls to <code>move()</code> inside of loops and I wrote some code to make the camera move in simple rectangles. Some problems then became clear: the pan tilt module either moves too slow, too fast or just spazzes out if you issue enough commands to it. Increasing the baud rate helped to speed things up, however it would still freak out if you told it to move really fast. I determined that there needs to be some delay between <code>move()</code> calls. Once again, I wrote some diagnostic code to determine this. The pan tilt module would move in rectangles with increasingly longer pauses between <code>move()</code> calls. At some critical delay value, the pan tilt module stopped jittering and moved smoothly (but still pretty fast) around the perimeter of the rectangle (turned out to be 0.003 seconds). As a final example of what the system can do, I wrote the spiral code that appears in the video above. It is only a few lines of python, but I spaced them out and commented them for ease of understanding:</p>
<pre><code class="language-python"><span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">spiral</span><span class="hljs-params">()</span>:</span>
    a = <span class="hljs-number">.01</span>;  <span class="hljs-comment"># "stretch" factor for sin and cosine</span>
    t = <span class="hljs-number">0</span>;    <span class="hljs-comment"># time value</span>

    <span class="hljs-comment"># time loop that stops when the stretch factor is 1</span>
    <span class="hljs-keyword">while</span> (a &lt; <span class="hljs-number">1</span>) :

        <span class="hljs-comment"># increase the time step</span>
        t+=<span class="hljs-number">1</span>

        <span class="hljs-comment"># if 50 time steps have gone by, increment a</span>
        <span class="hljs-keyword">if</span> (t % <span class="hljs-number">50</span> == <span class="hljs-number">0</span>) : a+=<span class="hljs-number">.01</span>

        <span class="hljs-comment"># move the servos to middle, plus or minus some scaled</span>
        <span class="hljs-comment"># value of sin or cosine. Change 'a' to something fixed</span>
        <span class="hljs-comment"># between 0 and 1 and the spiral is now a circle</span>
        servo.move(<span class="hljs-number">1</span>, <span class="hljs-number">90</span> + a * math.degrees(math.cos(math.radians(t))))
        servo.move(<span class="hljs-number">2</span>, <span class="hljs-number">90</span> + a * math.degrees(math.sin(math.radians(t))))

        <span class="hljs-comment"># delay between the move calls</span>
        time.sleep(<span class="hljs-number">.0045</span>)
</code></pre>
<h2>Conclusion &amp; Attachments</h2>
<p>So that was it! Now I have unrestricted access to use python to do (almost) whatever I want! Looking at the python bindings for OpenCV next!</p>
<ul>
<li><a href="http://dl.dropbox.com/u/4428042/stonelinks_public/main.cpp">Arduino main code</a></li>
<li><a href="http://dl.dropbox.com/u/4428042/stonelinks_public/servolimits.cpp">Arduino servo pulsewidth diagnostic code</a></li>
<li><a href="http://dl.dropbox.com/u/4428042/stonelinks_public/main.py">Python main code</a></li>
<li><a href="http://dl.dropbox.com/u/4428042/stonelinks_public/servo.py">Python servo module</a></li>
</ul>
</div><div data-reactid="23"><div style="margin-bottom:0.805rem;font-size:0.805rem;color:gray;" data-reactid="24"><span data-reactid="25"><!-- react-text: 26 -->Tags: <!-- /react-text --><a href="/tags/#robots" data-reactid="27">Robots</a><!-- react-text: 28 --> | <!-- /react-text --><a href="/tags/#computer-vision" data-reactid="29">Computer vision</a><!-- react-text: 30 --> | <!-- /react-text --><a href="/tags/#python" data-reactid="31">Python</a><!-- react-text: 32 --> | <!-- /react-text --><a href="/tags/#arduino" data-reactid="33">Arduino</a></span></div><hr style="background-color:gray;" data-reactid="34"/><div data-reactid="35"><h6 style="margin:0;font-size:0.78616rem;line-height:1.61rem;color:gray;" data-reactid="36">Read this next:</h6><h3 style="margin-top:0;margin-bottom:0.4025rem;" data-reactid="37"><a href="/posts/active-face-tracking-with-stonebot/" data-reactid="38"><!-- react-text: 39 --> <!-- /react-text --><!-- react-text: 40 -->Face Tracking with Stonebot<!-- /react-text --><!-- react-text: 41 --> <!-- /react-text --></a></h3><div data-reactid="42">I finally have it working! Very excited as I write this. So glad spring break exists otherwise I’d never have the time for this. Long story short, I have face detection working on my personal robot...</div><hr style="margin-top:1.61rem;background-color:gray;" data-reactid="43"/></div><p style="margin-bottom:1.61rem;" data-reactid="44"><a href="/about/" data-reactid="45"><img src="/author.png" alt="Lucas Doyle" style="float:left;margin-top:0;margin-bottom:0;margin-right:0.4025rem;width:3.22rem;height:3.22rem;border-radius:50%;border:1px gray solid;" data-reactid="46"/></a><span data-reactid="47"><!-- react-text: 48 -->Written by <!-- /react-text --><a href="/about/" data-reactid="49">Lucas Doyle</a><!-- react-text: 50 -->, a software engineer with a Robotics / GIS / UI focus in the SF Bay Area<!-- /react-text --></span></p></div></div><span style="display:block;clear:both;" data-reactid="51"> </span></div></div><script src="/bundle.js?t=1537396828742"></script></body></html>