<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>WebGL Blox | Stonelinks</title>

    <link rel="stylesheet" href="http://fonts.googleapis.com/css?family=PT+Sans:400italic,400,700">
    <link rel="stylesheet" href="assets/css/main.css">

    <!--[if lt IE 9]>
      <script src="assets/html5shiv/dist/html5shiv.min.js"></script>
      <script src="assets/respond/dest/respond.min.js"></script>
    <![endif]-->

    <script src="assets/vendor/jquery/jquery.min.js"></script>
    <script src="assets/vendor/underscore/underscore.js"></script>
    <script type="text/javascript">
      window.ASSETS = 'assets';
      window.BASENAME = 'blox';
      window.BG_IMAGES = 'dist/assets/img/backgrounds/0GBq3.jpg,dist/assets/img/backgrounds/1021101552.jpg,dist/assets/img/backgrounds/121027_162023_000.jpg,dist/assets/img/backgrounds/1780754_589564401120703_639857649_n (1).jpg,dist/assets/img/backgrounds/1979230_10152035339809685_1025831531_o.jpg,dist/assets/img/backgrounds/2000-01-01 08.30.12.jpg,dist/assets/img/backgrounds/2010-08-19 19.25.57.jpg,dist/assets/img/backgrounds/2010-08-21 01.04.54.jpg,dist/assets/img/backgrounds/2011-04-23_07-35-15_846.jpg,dist/assets/img/backgrounds/2012-05-21_12-21-51_382.jpg,dist/assets/img/backgrounds/2012-06-13_11-30-01_10.jpg,dist/assets/img/backgrounds/2012-06-13_13-04-51_940.jpg,dist/assets/img/backgrounds/2012-12-02 00.41.05.jpg,dist/assets/img/backgrounds/2012-12-06 15.09.02.jpg,dist/assets/img/backgrounds/2013-03-03 17.53.11.jpg,dist/assets/img/backgrounds/2013-05-01 08.31.27.jpg,dist/assets/img/backgrounds/2013-05-18 13.07.32.jpg,dist/assets/img/backgrounds/2013-08-22 13.00.42.jpg,dist/assets/img/backgrounds/2013-08-30 18.41.41.jpg,dist/assets/img/backgrounds/2013-08-30 19.58.14.jpg,dist/assets/img/backgrounds/2013-09-20 05.09.53.jpg,dist/assets/img/backgrounds/2013-09-20 05.26.41.jpg,dist/assets/img/backgrounds/2013-09-20 05.30.41.jpg,dist/assets/img/backgrounds/2013-09-20 05.32.01.jpg,dist/assets/img/backgrounds/2013-11-24 18.07.08.jpg,dist/assets/img/backgrounds/2013-11-24 19.05.27.jpg,dist/assets/img/backgrounds/2013-11-25 15.04.06.jpg,dist/assets/img/backgrounds/2013-12-20 14.27.13.jpg,dist/assets/img/backgrounds/2013-12-28 19.16.24.jpg,dist/assets/img/backgrounds/2048 (1).jpg,dist/assets/img/backgrounds/2048.jpg,dist/assets/img/backgrounds/2700262886_6b0fd48dc8_b.jpg,dist/assets/img/backgrounds/3248918413_1deff78256_o.jpg,dist/assets/img/backgrounds/34DnPmX.jpg,dist/assets/img/backgrounds/495251.jpg,dist/assets/img/backgrounds/5bml6q6.jpg,dist/assets/img/backgrounds/5gn0Uw6.jpg,dist/assets/img/backgrounds/75MtJTF.jpg,dist/assets/img/backgrounds/7SqL0BC.jpg,dist/assets/img/backgrounds/7jWBoem.jpg,dist/assets/img/backgrounds/A52It0Q.jpg,dist/assets/img/backgrounds/AYmUVEm.jpg,dist/assets/img/backgrounds/CWA87fd.jpg,dist/assets/img/backgrounds/CcMlC0x.jpg,dist/assets/img/backgrounds/DQBkjl0.jpg,dist/assets/img/backgrounds/Dtd8OaS.jpg,dist/assets/img/backgrounds/EWwV235.jpg,dist/assets/img/backgrounds/Eourq.jpg,dist/assets/img/backgrounds/FDoNLz1.jpg,dist/assets/img/backgrounds/GkWIkzl.jpg,dist/assets/img/backgrounds/GpCUV.jpg,dist/assets/img/backgrounds/IMG_1142 copy-X2.jpg,dist/assets/img/backgrounds/IMG_20120721_181258.jpg,dist/assets/img/backgrounds/IMG_20120825_201522.jpg,dist/assets/img/backgrounds/IPwZZ29.jpg,dist/assets/img/backgrounds/IQgb2Fb.jpg,dist/assets/img/backgrounds/IZyTICW.jpg,dist/assets/img/backgrounds/IijALtC.jpg,dist/assets/img/backgrounds/J8Oqyyd.jpg,dist/assets/img/backgrounds/KBMGZnm.jpg,dist/assets/img/backgrounds/MbN1OhC.jpg,dist/assets/img/backgrounds/NIkQVMz.jpg,dist/assets/img/backgrounds/ONn4OVE.jpg,dist/assets/img/backgrounds/PeoCslF.jpg,dist/assets/img/backgrounds/TUZyh.jpg,dist/assets/img/backgrounds/UP_EMD_SD9043AC_Joso_Bridge_USA.jpg,dist/assets/img/backgrounds/Up2Vo3r.jpg,dist/assets/img/backgrounds/XYWsmJC.jpg,dist/assets/img/backgrounds/Xn25v.jpg,dist/assets/img/backgrounds/XvkHfUA.jpg,dist/assets/img/backgrounds/YseOPg6.jpg,dist/assets/img/backgrounds/bHVlqeR.jpg,dist/assets/img/backgrounds/bXTsleX.jpg,dist/assets/img/backgrounds/d7t5BrZ.jpg,dist/assets/img/backgrounds/desert_city.jpg,dist/assets/img/backgrounds/enukwns.jpg,dist/assets/img/backgrounds/fr42b.jpg,dist/assets/img/backgrounds/hTkXfEY.jpg,dist/assets/img/backgrounds/heic0504b.jpg,dist/assets/img/backgrounds/highflight-operationa-go8.jpg,dist/assets/img/backgrounds/k9JWU9N.jpg,dist/assets/img/backgrounds/kQj6gNC.jpg,dist/assets/img/backgrounds/m1gD1NC.jpg,dist/assets/img/backgrounds/m95qL89.jpg,dist/assets/img/backgrounds/mooCZ.jpg,dist/assets/img/backgrounds/n0qGynd.jpg,dist/assets/img/backgrounds/nLpQ2G3.jpg,dist/assets/img/backgrounds/ozjI2XF.jpg,dist/assets/img/backgrounds/pTApMWS.jpg,dist/assets/img/backgrounds/raddmHE.jpg,dist/assets/img/backgrounds/rhvP0wn.jpg,dist/assets/img/backgrounds/s_f02_RTR3FJM0.jpg,dist/assets/img/backgrounds/tmEkJ7Q.jpg,dist/assets/img/backgrounds/uMrsMXh.jpg,dist/assets/img/backgrounds/vmBnAIS.jpg,dist/assets/img/backgrounds/wallpaper-1312831.jpg,dist/assets/img/backgrounds/wallpaper-1441536.jpg,dist/assets/img/backgrounds/wjZsmhr.jpg,dist/assets/img/backgrounds/xkl9FoE.jpg,dist/assets/img/backgrounds/xrH9T22.jpg,dist/assets/img/backgrounds/y4WGD7I.jpg,dist/assets/img/backgrounds/yrZCDd1.jpg,dist/assets/img/backgrounds/ywhjtHh.jpg,dist/assets/img/backgrounds/znfvr.jpg'.split(',');
    </script>
    <script src="assets/js/main.js"></script>
  </head>
  <body>

    

<script src="assets/vendor/threejs-r49/build/Three.js"></script>

<script src="assets/vendor/threejs-r49/examples/js/Detector.js"></script>
<script src="assets/js/blox-misc/ViewportControls.js"></script>
<script src="assets/js/blox-misc/ShaderExtras.js"></script>

<script src="assets/vendor/threejs-r49/examples/js/postprocessing/EffectComposer.js"></script>
<script src="assets/vendor/threejs-r49/examples/js/postprocessing/RenderPass.js"></script>
<script src="assets/vendor/threejs-r49/examples/js/postprocessing/ShaderPass.js"></script>
<script src="assets/vendor/threejs-r49/examples/js/postprocessing/MaskPass.js"></script>
<script src="assets/vendor/threejs-r49/examples/js/postprocessing/BloomPass.js"></script>
<script src="assets/vendor/threejs-r49/examples/js/postprocessing/FilmPass.js"></script>

<script src="assets/vendor/threejs-r49/examples/fonts/gentilis_bold.typeface.js"></script>
<script src="assets/vendor/threejs-r49/examples/fonts/gentilis_regular.typeface.js"></script>
<script src="assets/vendor/threejs-r49/examples/fonts/optimer_bold.typeface.js"></script>
<script src="assets/vendor/threejs-r49/examples/fonts/optimer_regular.typeface.js"></script>
<script src="assets/vendor/threejs-r49/examples/fonts/helvetiker_bold.typeface.js"></script>
<script src="assets/vendor/threejs-r49/examples/fonts/helvetiker_regular.typeface.js"></script>
<script src="assets/vendor/threejs-r49/examples/fonts/droid/droid_sans_regular.typeface.js"></script>
<script src="assets/vendor/threejs-r49/examples/fonts/droid/droid_sans_bold.typeface.js"></script>
<script src="assets/vendor/threejs-r49/examples/fonts/droid/droid_serif_regular.typeface.js"></script>
<script src="assets/vendor/threejs-r49/examples/fonts/droid/droid_serif_bold.typeface.js"></script>

<script type="text/javascript">

if (!Detector.webgl) Detector.addGetWebGLMessage();

var block = function(color, x, y) {
  var _this = this;
  _this.color = color;
  _this.x = x;
  _this.y = y;
  _this.x_offset = 0.3;

  var geometry = new THREE.CubeGeometry(1, 1, 1);
  //var geometry = new THREE.IcosahedronGeometry(0.6, 1.0);
  var material = new THREE.MeshPhongMaterial({
    opacity: 0.95,
    ambient: 0x000000,
    color: color,
    specular: 0x555555,
    shininess: 3,
    shading: THREE.Flatshading
  });

  geometry.computeBoundingBox();
  geometry.computeVertexNormals();

  _this.block_mesh = new THREE.Mesh(geometry, material);

  _this.block_mesh.position.x = x - boardWidth / 2 + _this.x_offset;
  _this.block_mesh.position.y = y - boardHeight / 2;

  _this.block_mesh.scale.x = 0.8;
  _this.block_mesh.scale.y = 0.8;

  _this.block_mesh._parent = _this;

  scene.add(_this.block_mesh);

  // deletes this block from the board
  this.delete_block = function() {
    board[_this.x][_this.y] = null;
    scene.remove(_this.block_mesh);
  };

  // moves the block to a specified location
  this._move = function(dest_x, dest_y) {
    log('moving ' + _this.x + ', ' + _this.y + ' to ' + dest_x + ', ' + dest_y);
    if (board[dest_x][dest_y] != null) {
      log('WARNING, space ' + dest_x + ', ' + dest_y + ' has something in it');
    }

    var steps = 10;
    var delay = 20;

    var start_x = _this.x;
    var start_y = _this.y;
    var t = 0;
    var dir_x, dir_y;

    if (start_x > dest_x) dir_x = -1;
    else dir_x = 1;
    if (start_y > dest_y) dir_y = -1;
    else dir_y = 1;

    var update_block_pos = function() {
        _this.block_mesh.position.x = _this.x - boardWidth / 2 + _this.x_offset;
        _this.block_mesh.position.y = _this.y - boardHeight / 2;
      };

    var interval = setInterval(function() {
      _this.x += dir_x * (dest_x - start_x) / steps;
      // j is inverted
      _this.y += -1 * dir_y * (dest_y - start_y) / steps;
      update_block_pos();
      t++;
      if (t >= steps) {
        _this.x = dest_x;
        _this.y = dest_y;
        update_block_pos();
        clearInterval(interval);
      }
    }, delay);
  };
};

// Three.js objects
var container;
var camera, scene, renderer;
var projector = new THREE.Projector()
var SHADOW_MAP_WIDTH = 2048;
var SHADOW_MAP_HEIGHT = 1024;

// mouse interaction
var mouse = {
  x: 0,
  y: 0
};
var INTERSECTED, selectedBlock;
var controls;
var enable_controls = false;

// game objects
var boardWidth = 8;
var boardHeight = 9;
var board = [];
var coloredNeighbors = [];
var columnList = [];

var textMesh;
var text;
var score = 0;

// main
init();
animate();

function init() {
  container = document.createElement('div');
  container.style.position = 'absolute';
  container.style.overflow = 'hidden';
  document.body.appendChild(container);

  scene = new THREE.Scene();
  camera = new THREE.PerspectiveCamera(60, window.innerWidth / window.innerHeight, 1, 10000);

  camera.position.set(0, 0, 10);
  camera.rotation.set(0, 0, 1);
  camera.lookAt(new THREE.Vector3());
  scene.add(camera);

  var light = new THREE.DirectionalLight(0xffffff, .2);
  light.position.set(0, 0, 100);
  scene.add(light);

  var l = [
    [0, 0, 50],
    [0, 0, -50],
    [0, 50, 0],
    [0, -50, 0],
    [50, 0, 0],
    [-50, 0, 0]
  ];

  for (var i = 0; i < 6; i++) {
    var pointLight = new THREE.PointLight(0xffffff, .7);
    pointLight.position.set(l[i][0], l[i][1], l[i][2]);
    scene.add(pointLight);
  }

  renderer = new THREE.WebGLRenderer({
    clearAlpha: 1,
    clearColor: 0x808080
  });

  renderer.shadowCameraNear = 3;
  renderer.shadowCameraFar = camera.far;
  renderer.shadowCameraFov = 50;
  renderer.shadowMapBias = 0.0039;
  renderer.shadowMapDarkness = 0.5;
  renderer.shadowMapWidth = SHADOW_MAP_WIDTH;
  renderer.shadowMapHeight = SHADOW_MAP_HEIGHT;
  renderer.shadowMapEnabled = true;
  renderer.shadowMapSoft = true;
  renderer.setSize(window.innerWidth, window.innerHeight);
  container.appendChild(renderer.domElement);

  // POSTPROCESSING
  renderer.autoClear = true;

  var renderModel = new THREE.RenderPass(scene, camera);
  var effectBloom = new THREE.BloomPass(0.25);
  var effectFilm = new THREE.FilmPass(0.5, 0.125, 2048, false);
  var effectFXAA = new THREE.ShaderPass(THREE.ShaderExtras["fxaa"]);

  effectFXAA.uniforms['resolution'].value.set(1 / window.innerWidth, 1 / window.innerHeight);

  effectFilm.renderToScreen = true;

  composer = new THREE.EffectComposer(renderer);

  composer.addPass(renderModel);
  composer.addPass(effectFXAA);
  composer.addPass(effectBloom);
  composer.addPass(effectFilm);

  if (enable_controls) {
    controls = new THREE.ViewportControls(camera, renderer.domElement);
    controls.rotateSpeed = 1.0;
    controls.zoomSpeed = 1.2;
    controls.panSpeed = 0.2;
    controls.noZoom = false;
    controls.noPan = false;
    controls.staticMoving = false;
    controls.dynamicDampingFactor = 0.3;
    controls.minDistance = 0;
    controls.maxDistance = 500 * 100;
    controls.keys = [65, 83, 68]; // [ rotateKey, zoomKey, panKey ]
  }

  updateScore(2);

  for (var i = 0; i < boardWidth; i++) {
    var col = [];
    for (var j = 0; j < boardHeight; j++) {
      var _block = new block(colorGenerator(), i, j);
      col.push(_block);
    }
    board.push(col);
  }
  container.addEventListener('mousemove', onDocumentMouseMove, false);
  container.addEventListener('mouseup', onDocumentMouseUp, false);
};

function onDocumentMouseMove(event) {
  event.preventDefault();
  mouse.x = (event.clientX / window.innerWidth) * 2 - 1;
  mouse.y = -(event.clientY / window.innerHeight) * 2 + 1;
};

function onDocumentMouseUp(event) {
  event.preventDefault();
  if (INTERSECTED) {
    deleteNeighbors(selectedBlock);
  }
};

function updateScore(amount) {
  score += amount - 2;
  printText("Score: " + score);
};

function printText(msg) {
  text = msg;
  scene.remove(textMesh);
  createText();
};

function createText() {
  var faceMaterial = new THREE.MeshFaceMaterial();
  var textMaterialFront = new THREE.MeshPhongMaterial({
    color: 0xffffff,
    shading: THREE.FlatShading
  });

  var height = 0.1;
  var size = 0.5;
  var hover = 4.5;

  var curveSegments = 0.1;

  var font = "optimer";
  var weight = "bold";
  var style = "normal";

  var textGeo = new THREE.TextGeometry(text, {
    size: size,
    height: height,
    curveSegments: curveSegments,
    font: font,
    weight: weight,
    style: style,
    material: 0,
    extrudeMaterial: 0
  });

  textGeo.materials = [textMaterialFront];

  textGeo.computeBoundingBox();
  textGeo.computeVertexNormals();

  var centerOffset = -0.5 * (textGeo.boundingBox.max.x - textGeo.boundingBox.min.x);

  textMesh = new THREE.Mesh(textGeo, faceMaterial);

  textMesh.position.x = centerOffset;
  textMesh.position.y = hover;
  textMesh.position.z = 0;

  scene.add(textMesh);
};

function findNeighbors(block) {
  var neighbors = [];
  log('finding neighbors of ' + block.x + ', ' + block.y);

  if (block.x >= 0 && block.x <= boardWidth - 2) neighbors.push(board[block.x + 1][block.y]);
  if (block.y >= 0 && block.y <= boardHeight - 2) neighbors.push(board[block.x][block.y + 1]);
  if (block.x <= boardWidth - 1 && block.x >= 1) neighbors.push(board[block.x - 1][block.y]);
  if (block.y <= boardHeight - 1 && block.y >= 1) neighbors.push(board[block.x][block.y - 1]);

  for (var k = 0; k < neighbors.length; k++) {
    var thisNeighbor = neighbors[k];
    if (thisNeighbor == null || thisNeighbor.color != block.color) {
      continue;
    }
    var inNeighbors = false;
    for (var l = 0; l < coloredNeighbors.length; l++) {
      if (thisNeighbor.y == coloredNeighbors[l].y && thisNeighbor.x == coloredNeighbors[l].x) {
        inNeighbors = true;
        break;
      }
    }
    if (!inNeighbors) {
      log('adding ' + thisNeighbor.x + ', ' + thisNeighbor.y + ' to neighbors');
      coloredNeighbors.push(thisNeighbor);
      findNeighbors(thisNeighbor);
    }
  }
};

function deleteNeighbors(block) {
  coloredNeighbors = [block];
  findNeighbors(block);
  if (coloredNeighbors.length >= 3) {
    log('deleting neighbors for ' + block.x + ', ' + block.y);
    var colTracker = {};
    for (var i = 0; i < coloredNeighbors.length; i++) {
      coloredNeighbors[i].delete_block();
      colTracker[coloredNeighbors[i].x.toString()] = 1;
    }
    for (var col in colTracker) {
      columnList.push(parseInt(col));
    }

    updateScore(coloredNeighbors.length);

  } else {
    log('no neighbors for ' + block.x + ', ' + block.y);
  }
};

function fillColumn(index) {
  var j = 0;
  while (j != boardHeight) {
    // if the next space is the top and it is null create a new block, go back one
    if (j + 1 == boardHeight && board[index][boardHeight - 1] == null) {
      var _block = new block(colorGenerator(), index, boardHeight - 1);
      board[index][boardHeight - 1] = _block;
      j = 0;
    }
    // if this block is null
    if (board[index][j] == null) {
      var amount = 1;
      while (board[index][j + amount] == null) {
        if (j + amount >= boardHeight) break;
        else amount++;
      }
      // move it down
      if (board[index][j + amount] != null) {
        moveDown(board[index][j + amount], amount);
      }
    }
    j++;
  }
  log('done filling holes');
};

function moveDown(block, amount) {
  move(block, block.x, block.y - amount);
};

function move(block, dest_x, dest_y) {
  board[dest_x][dest_y] = block;
  board[block.x][block.y] = null;
  block._move(dest_x, dest_y);
};

function animate() {
  requestAnimationFrame(animate);

  composer.render(0.05);

  if (enable_controls) {
    controls.update();
  }

  // fill columns
  if (columnList.length > 0) {
    for (var i = 0; i < columnList.length; i++) {
      log('filling col ' + columnList[i]);
      fillColumn(columnList[i]);
      columnList.remove(i);
    }
  }

  // find intersections
  var vector = new THREE.Vector3(mouse.x, mouse.y, 1);
  projector.unprojectVector(vector, camera);
  var ray = new THREE.Ray(camera.position, vector.subSelf(camera.position).normalize());
  var intersects = ray.intersectObjects(scene.children);

  if (intersects.length > 0) {
    if (INTERSECTED != intersects[0].object) {
      INTERSECTED = intersects[0].object;
      selectedBlock = INTERSECTED._parent;
    }
  } else {
    if (INTERSECTED) {
      INTERSECTED = null;
      selectedBlock = null;
    }
  }
  renderer.render(scene, camera);
};

//////////////////////////////////
// utility functions
//////////////////////////////////

// Array Remove - By John Resig (MIT Licensed)
Array.prototype.remove = function(from, to) {
  var rest = this.slice((to || from) + 1 || this.length);
  this.length = from < 0 ? this.length + from : from;
  return this.push.apply(this, rest);
};

function log(msg) {
  setTimeout(function() {
    console.log(msg);
  }, 0);
};

function colorGenerator() {
  var colors = [
  0xff0000, //red
  0x00ff00, //green
  0x0000ff, //blue
  0xffff00, //yellow
  0xa020f0, //purple
  0x00FFE3, //purple
  ];
  return colors[Math.floor(Math.random() * colors.length)];
};

</script>


  </body>
</html>
