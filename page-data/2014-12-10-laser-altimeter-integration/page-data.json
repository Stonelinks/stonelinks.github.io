{
    "componentChunkName": "component---src-templates-blog-post-tsx",
    "path": "/2014-12-10-laser-altimeter-integration/",
    "result": {"data":{"site":{"siteMetadata":{"title":"Stonelinks"}},"markdownRemark":{"id":"8f792372-8de0-593c-803b-0be8e4a5b2f2","excerpt":"As some of you may know, I have left Tokyo and the world of industrial robotics and am now in the midst of immersing myself in the world of drones in San…","html":"<p>As some of you may know, I have left Tokyo and the world of industrial robotics and am now in the midst of immersing myself in the world of drones in San Francisco. Its a very exciting time in my life! Among other things, I did some research into the different drone platforms out there.</p>\n<p>As a sample exercise, I took an in-depth look at how I’d go about integrating a laser altimeter on to the 3DR Pixhawk.</p>\n<h2>Step 0: Source a sensor</h2>\n<p>All signs of googling point to the <a href=\"http://www.lightware.co.za/shop/en/lrf-modules/7-sf02f.html\">SF02/F laser altimeter</a> as the quickest option to get something working.</p>\n<p><img src=\"https://pixhawk.org/_media/peripherals/sf02_f_laser_rangefinder_pixhawk_wiring.jpg?w=600&#x26;tok=605f64\" alt=\"\"></p>\n<p><strong>Specs</strong>:</p>\n<ul>\n<li><strong>Manufacturer</strong>: A South African company called <a href=\"http://www.lightware.co.za/shop/en/\">lightware</a></li>\n<li><strong>Weight</strong>: 69 g</li>\n<li><strong>Range</strong>: 0-40 m</li>\n<li><strong>Resolution</strong>: 1 cm</li>\n<li><strong>Price and availability</strong>: $300 each, currently on backorder!</li>\n<li><strong>Update rate</strong>: 12 hz</li>\n<li><strong>Outputs &#x26; interfaces</strong>: Analog, serial and digital</li>\n<li><strong>Power supply voltage</strong>: 6.5-9.0 V or 5.0 V ± 0.5 V DC</li>\n<li><strong>Power supply current</strong>: 150 mA (maximum)</li>\n<li><strong>Dimensions</strong>: 27 x 59 x 86 mm</li>\n</ul>\n<p><strong>Pros</strong>:</p>\n<ul>\n<li>Good <a href=\"https://pixhawk.org/platforms/planes/phantom_fpv_flying_wing#px4_fmu_build_log\">example applications</a> on UAVs using Pixhawk already out there.</li>\n<li><a href=\"https://pixhawk.org/peripherals/rangefinder\">Documentation</a> on how to interface and a <a href=\"https://github.com/PX4/Firmware/tree/master/src/drivers/sf0x\">Pixhawk driver</a> already exists.</li>\n<li>It is a high quality piece of equipment. This guy gave it <a href=\"http://diydrones.com/profiles/blogs/sf02-laser-altimeter-review\">a unbiased, positive review</a>.</li>\n<li>Manufacturer includes <a href=\"http://www.lightware.co.za/shop/en/content/8-software\">software</a> that can be used to test the sensor independently from the Pixhawk.</li>\n<li>Good activity and info from the <a href=\"http://diydrones.com/profile/LaserDeveloper\">manufacturer’s DIY drones account</a>. Seem to help people with their problems and provide good feedback.</li>\n</ul>\n<p><strong>Cons</strong>:</p>\n<ul>\n<li>The 40 m range is likely too short for any application other than automated landings. 40 m is fine for landings since those obviously occur close to the ground. However if you’re using the rangefinder for data acquisition the entire flight, then 40 m is too short. <a href=\"http://diydrones.com/forum/topics/looking-for-new-technology-1?commentId=705844%3AComment%3A1761627&#x26;xg_source=activity\">Supposedly the company is developing another similar sensor</a> with a longer range.</li>\n<li>Expensive! At $300 a pop, equipping a fleet of drones with these will be pricey.</li>\n<li>Looks like the manufacturer is making these only for the hobbyist market. This means that they may make them in bulk, they might not be made to high industrial standards or that there it could be suddenly discontinued if they decide the hobbyist market isn’t worth it.</li>\n</ul>\n<p><strong>Alternatives</strong>:</p>\n<p>To address some of the SF02’s cons (and given that we’re equipping a fleet), I looked for an alternate sensor on <a href=\"http://www.alibaba.com/\">Alibaba</a>. If you’re not familiar with Alibaba, it is basically a way to buy wholesale electronics / components / sub-assemblies directly from Chinese suppliers. The best option I found for a laser rangefinder module is <a href=\"http://www.alibaba.com/product-detail/rangefinder-module_713054756.html\">this sensor</a>. It is $100 - $300, so potentially a third of the cost per unit compared to the SF02, which is a massive savings. The range is also much better (says 10 - 800 m). Details on power consumption and how to interface with it are not clear, but I’m sure talking with the manufacturer (which is easy on Alibaba) would clear that up. Finally, the stated minimum distance (10 m) and accuracy (1 m vs. the SF02’s 1 cm) is pretty bad and won’t be useful for landings.</p>\n<p><a href=\"http://www.dragoninnovation.com/projects/32-lidar-lite-by-pulsedlight\">This sensor is intriguing</a> but not yet available. Good to keep an eye on, especially since <a href=\"https://store.3drobotics.com/products/lidar-lite/\">3DR seems to be supporting it</a>. Far cheaper and smaller but still only a 40 m range.</p>\n<p>So while these other sensors may potentially work, for the sake of this analysis I’m going to with the SF02.</p>\n<h2>Step 1: Connect to the Pixhawk</h2>\n<p>The wiring from the SF02 to the Pixhawk goes like this:</p>\n<table>\n<thead>\n<tr>\n<th>Pixhawk <span class=\"caps\">UART</span> pin</th>\n<th><span class=\"caps\">SF02</span>/F pin</th>\n<th>Comment </th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td> 1 / +5V</td>\n<td>3 / +5V</td>\n<td>Power supply </td>\n</tr>\n<tr>\n<td> 2 / <span class=\"caps\">TX</span></td>\n<td>9 / <span class=\"caps\">RX</span></td>\n<td>3.3V <span class=\"caps\">UART</span> <span class=\"caps\">SF02</span>/F receive </td>\n</tr>\n<tr>\n<td> 3 / <span class=\"caps\">RX</span></td>\n<td>8 / <span class=\"caps\">TX</span></td>\n<td>3.3V <span class=\"caps\">UART</span> <span class=\"caps\">SF02</span>/F transmit </td>\n</tr>\n<tr>\n<td> 6 / <span class=\"caps\">GND</span></td>\n<td>2 / -</td>\n<td>Ground </td>\n</tr>\n</tbody>\n</table>\n<p>Since the SF02 uses screw terminals, depending on how much the aircraft vibrates it may be a good idea to soldier up the leads to the screw terminal. This is the <a href=\"https://store.3drobotics.com/products/df13-6-position-connector-45-cm\">cable / connector</a> you’d use. Plug the SF02 into TELEM2 of the Pixhawk.</p>\n<h2>Step 2: Install on the aircraft</h2>\n<p>You’ll want to put the sensor pointing at the ground obviously, keeping it perpendicular to the aircraft. The sensor should also be mounted in a recessed position so that the optics arn’t scratched during a rough landing. Also, it should be positioned such that it doesn’t mess with the center of gravity for the aircraft otherwise it will affect glide characteristics.</p>\n<h2>Step 3: Software</h2>\n<p><strong>Drivers</strong></p>\n<p>The <a href=\"https://github.com/PX4/Firmware/tree/master/src/drivers/sf0x\">sf0x driver</a> needed for the Pixhawk is already part of the firmware. To start the driver:</p>\n<p><strong>Drivers</strong></p>\n<p>The <a href=\"https://github.com/PX4/Firmware/tree/master/src/drivers/sf0x\">sf0x driver</a> needed for the Pixhawk is already part of the firmware. To start the driver:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">sf0x start</code></pre></div>\n<p>And to run a test and verify the sensor is working:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">sf0x <span class=\"token builtin class-name\">test</span></code></pre></div>\n<p>Add a file called <code class=\"language-text\">etc/extras.txt</code> to your microSD card with this content to autostart the driver:</p>\n<div class=\"gatsby-highlight\" data-language=\"bash\"><pre class=\"language-bash\"><code class=\"language-bash\">sf0x start</code></pre></div>\n<p><strong>Receiving sensor data in your PX4 application</strong></p>\n<p>PX4 has some great hardware abstraction, so we don’t have to directly interact with the driver at all. Instead, we <a href=\"http://pixhawk.org/dev/px4_simple_app#step_5subscribing_sensor_data\">subscribe to inter-process messages</a> published by the sensor driver. In order to get data from the laser rangefinder, we need to subscribe to the topic that it publishes on. <a href=\"http://pixhawk.org/dev/shared_object_communication\">This</a> is a good resource on how to do that. Looking at the source for the <code class=\"language-text\">sf0x</code> driver, we need to subscribe to the <code class=\"language-text\">sensor_range_finder</code> topic which comes from <a href=\"https://github.com/PX4/Firmware/blob/master/src/drivers/drv_range_finder.h\"><code class=\"language-text\">drivers/drv_range_finder.h</code></a>. So in our application we’d subscribe like this:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;drivers/drv_range_finder.h></span></span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">int</span> rangefinder_sub_fd <span class=\"token operator\">=</span> <span class=\"token function\">orb_subscribe</span><span class=\"token punctuation\">(</span><span class=\"token function\">ORB_ID</span><span class=\"token punctuation\">(</span>sensor_range_finder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>To actually get data out of the subscriber, we need to use the <code class=\"language-text\">poll()</code> POSIX system call. This approach will sleep the thread (consuming no CPU cycles) until data from the sensor actually gets published. We achieve this like so:</p>\n<div class=\"gatsby-highlight\" data-language=\"c\"><pre class=\"language-c\"><code class=\"language-c\"><span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;poll.h></span></span>\n<span class=\"token macro property\"><span class=\"token directive-hash\">#</span><span class=\"token directive keyword\">include</span> <span class=\"token string\">&lt;drivers/drv_range_finder.h></span></span>\n<span class=\"token punctuation\">.</span><span class=\"token punctuation\">.</span>\n<span class=\"token keyword\">int</span> rangefinder_sub_fd <span class=\"token operator\">=</span> <span class=\"token function\">orb_subscribe</span><span class=\"token punctuation\">(</span><span class=\"token function\">ORB_ID</span><span class=\"token punctuation\">(</span>sensor_range_finder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token comment\">/* one could wait for multiple topics with this technique, just using one here */</span>\n\n<span class=\"token keyword\">struct</span> <span class=\"token class-name\">pollfd</span> fds<span class=\"token punctuation\">[</span><span class=\"token punctuation\">]</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n  <span class=\"token punctuation\">{</span> <span class=\"token punctuation\">.</span>fd <span class=\"token operator\">=</span> rangefinder_sub_fd<span class=\"token punctuation\">,</span>   <span class=\"token punctuation\">.</span>events <span class=\"token operator\">=</span> POLLIN <span class=\"token punctuation\">}</span><span class=\"token punctuation\">,</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">while</span> <span class=\"token punctuation\">(</span>true<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n  <span class=\"token comment\">/* wait for sensor update of 1 file descriptor for 1000 ms (1 second) */</span>\n\n  <span class=\"token keyword\">int</span> poll_ret <span class=\"token operator\">=</span> <span class=\"token function\">poll</span><span class=\"token punctuation\">(</span>fds<span class=\"token punctuation\">,</span> <span class=\"token number\">1</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1000</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token keyword\">if</span> <span class=\"token punctuation\">(</span>fds<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>revents <span class=\"token operator\">&amp;</span> POLLIN<span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\n    <span class=\"token comment\">/* obtained data for the first file descriptor */</span>\n\n    <span class=\"token keyword\">struct</span> <span class=\"token class-name\">range_finder_report</span> rangefinder_data<span class=\"token punctuation\">;</span>\n\n    <span class=\"token comment\">/* copy rangefinder data into local buffer */</span>\n\n    <span class=\"token function\">orb_copy</span><span class=\"token punctuation\">(</span><span class=\"token function\">ORB_ID</span><span class=\"token punctuation\">(</span>sensor_range_finder<span class=\"token punctuation\">)</span><span class=\"token punctuation\">,</span> rangefinder_sub_fd<span class=\"token punctuation\">,</span> <span class=\"token operator\">&amp;</span>rangefinder_data<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n    <span class=\"token function\">printf</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Rangefinder distance:\\t%8.4f\\t%8.4f\\t%8.4f\\n\"</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">double</span><span class=\"token punctuation\">)</span>rangefinder_data<span class=\"token punctuation\">.</span>distance<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n  <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span></code></pre></div>\n<h2>Step 4: use it in your application</h2>\n<p>The code snippet above isn’t a complete application, but you get the idea. Once the range finder data is copied into that <code class=\"language-text\">range_finder_report</code> struct instance, the sky is the limit (pun intended) for what you want to do to it. This is where higher level, application specific things get implemented. Some things I can think of to do with altimeter data:</p>\n<ul>\n<li>Log the data, fly the drone fleet in a lawnmower / zig zag pattern to try to cover a large area, and then use it for 3d reconstruction later. To do this you would also need a decent estimate of aircraft position and orientation.</li>\n<li>Transmit data to a ground station for similar logging purposes. The ground station could be the central data aggregation point for the fleet. If the ground station has an internet connection, it could run a webserver for others to monitor aircraft data in real time from off-site.</li>\n<li>Implement an automated landing routine. Would need to figure out at what speed / altitude you’d need to flare the aircraft right before touchdown.</li>\n</ul>\n<p>Without knowing any more details about the exact application, I think this is where I’ll stop.</p>","frontmatter":{"title":"Laser Altimeter Integration on Pixhawk","date":"December 10, 2014","description":null}},"previous":{"fields":{"slug":"/2014-10-10-new-webgl-projects/"},"frontmatter":{"title":"New WebGL Projects"}},"next":{"fields":{"slug":"/2015-02-11-google-io-summary/"},"frontmatter":{"title":"Google I/O 2015 Summary"}}},"pageContext":{"id":"8f792372-8de0-593c-803b-0be8e4a5b2f2","previousPostId":"46d1d461-0c17-5ca1-82d3-206f5b5364a5","nextPostId":"d830f6b0-11ee-57bb-a7bf-95d912bc3d27"}},
    "staticQueryHashes": ["1632011873","2841359383"]}